<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xverseé’±åŒ…ç©ºæŠ•æ‰¹é‡æŸ¥è¯¢ï¼šFORâ€¢THEâ€¢CHILDREN</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin-top: 50px;
            padding: 30px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        .info {
            margin-bottom: 30px;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            resize: vertical;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        #result {
            margin-top: 30px;
        }
        .summary {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Xverseé’±åŒ…ç©ºæŠ•æ‰¹é‡æŸ¥è¯¢ï¼šFORâ€¢THEâ€¢CHILDREN</h1>
        <div class="info">
            <p>æ¥å£ç¹å¿™æ—¶å¯ä»¥: <a href="https://rune.ordinalgenesis.xyz/claim/4f6caebd-660d-4c6e-9aad-44ec05dbba1b" target="_blank">æ‰‹åŠ¨æŸ¥è¯¢&nbsp;<i class="bi bi-box-arrow-up-right"></i></a></p>
            <p><a href="https://ybot.io" target="_blank">Runesç¬¦æ–‡æ‰¹é‡é“¸é€ ï¼šybot.io&nbsp;<i class="bi bi-box-arrow-up-right"></i></a>ï¼ˆå…¨ç½‘é“¸é€ æˆæœ¬æœ€ä½ï¼Œæ”¯æŒæ— é™åŠ é€Ÿï¼ï¼‰</p>
        </div>
        <div class="mb-3">
            <textarea class="form-control" placeholder="è¾“å…¥åœ°å€åˆ—è¡¨,æ¯è¡Œä¸€ä¸ªåœ°å€" id="address-input"></textarea>
        </div>
        <div class="d-grid">
            <button class="btn btn-primary" type="button" id="query-btn">
                <i class="bi bi-search"></i> æ‰¹é‡æŸ¥è¯¢
            </button>
        </div>
        <div id="result"></div>
        <p class="author-info">
            byï¼šè€å¶1999.eth &nbsp;&nbsp;ä½œè€…æ¨ç‰¹ï¼š<a href="https://twitter.com/1999_eth" target="_blank">https://twitter.com/1999_eth</a>
        </p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const addressInput = document.getElementById('address-input');
        const queryBtn = document.getElementById('query-btn');
        const resultDiv = document.getElementById('result');
    
        queryBtn.addEventListener('click', async function() {
            let addresses = addressInput.value.split('\n').filter(address => address.trim() !== '');
            addresses = await convertAddresses(addresses);

            // æ¸…ç©ºä¸Šä¸€æ¬¡çš„ç»“æœ
            resultDiv.innerHTML = '';

            // åˆ›å»ºç´¯è®¡ä½™é¢å’Œå¯¼å‡ºæŒ‰é’®çš„å®¹å™¨
            let summaryContainer = document.createElement('div');
            summaryContainer.className = 'd-flex justify-content-between align-items-center mb-3 mt-4';
            summaryContainer.id = 'total-summary-container';

            let totalSummarySpan = document.createElement('span');
            totalSummarySpan.id = 'total-summary';
            totalSummarySpan.textContent = 'ç©ºæŠ•æ•°é‡ï¼šæ­£åœ¨æŸ¥è¯¢...';
            summaryContainer.appendChild(totalSummarySpan);

            // åœ¨ç»“æœä¹‹å‰æ’å…¥ç´¯è®¡ä½™é¢å®¹å™¨
            resultDiv.parentNode.insertBefore(summaryContainer, resultDiv);

            let resultTable = document.createElement('table');
            resultTable.className = 'table table-striped';
            resultTable.innerHTML = '<thead><tr><th>é’±åŒ…åœ°å€</th><th>ä»£å¸æ•°é‡</th></tr></thead><tbody>';

            addresses.forEach((address, index) => {
                let row = resultTable.insertRow(-1);
                row.id = 'address-row-' + index;
                row.insertCell(0).textContent = address;
                row.insertCell(1).id = 'merl-' + index;  // ä¿®æ”¹ä»£å¸æ•°é‡å•å…ƒæ ¼çš„ID
                row.cells[1].textContent = 'æ­£åœ¨æŸ¥è¯¢...';
            });

            resultTable.appendChild(document.createElement('tbody'));
            resultDiv.appendChild(resultTable);

            processBatch(addresses, 0, 0);
        });

        async function convertAddresses(inputAddresses) {
            return Promise.all(inputAddresses);
        }

        async function convertBTCtoETH(btcAddress) {
            try {
                const response = await fetch(`https://bridge.merlinchain.io/api/v1/address/match_by_btc?address=${btcAddress}`);
                const data = await response.json();
                return data.data.aa; // Return the converted 0x address
            } catch (error) {
                console.error('Error converting BTC address', btcAddress, error);
                return null; // Return null if conversion fails to use the original BTC address
            }
        }

        async function processBatch(addresses, startIndex, totalBalance) {
            const batchSize = 10;
            const endIndex = Math.min(startIndex + batchSize, addresses.length);
            const batch = addresses.slice(startIndex, endIndex);

            const batchPromises = batch.map((address, index) => updateBalance(address, startIndex + index));
            const batchResults = await Promise.all(batchPromises);

            const batchTotal = batchResults.reduce((acc, curr) => acc + (isNaN(curr) ? 0 : curr), 0);
            const newTotalBalance = totalBalance + batchTotal;
            document.getElementById('total-summary').textContent = 'ç©ºæŠ•ç´¯è®¡: ' + newTotalBalance + ' ğŸ‘';

            // åœ¨å¤„ç†å®Œæ‰€æœ‰åœ°å€åæ·»åŠ å¯¼å‡ºæŒ‰é’®
            if (endIndex >= addresses.length) {
                addExportButton();
            } else {
                processBatch(addresses, endIndex, newTotalBalance);
            }
        }

        function addExportButton() {
            let exportBtn = document.getElementById('export-btn');
            if (!exportBtn) {
                exportBtn = document.createElement('button');
                exportBtn.className = 'btn btn-secondary';
                exportBtn.id = 'export-btn';
                exportBtn.textContent = 'å¯¼å‡ºè¡¨æ ¼';
                exportBtn.addEventListener('click', exportToCSV);
                document.getElementById('total-summary-container').appendChild(exportBtn);
            }
        }

            
        async function updateBalance(address, index) {
            let response = await getBalance(address);
            document.getElementById('merl-' + index).textContent = response.merl !== 'æ¥å£ç¹å¿™' ? response.merl + ' ğŸ‘' : 'æ¥å£ç¹å¿™';
            return isNaN(response.merl) ? 0 : parseFloat(response.merl);
        }
    
        async function getBalance(address) {
            const uniqueId = "4f6caebd-660d-4c6e-9aad-44ec05dbba1b";
            const requestBody = JSON.stringify({
                uniqueId: uniqueId,
                senderAddress: address
            });

            let retries = 3;
            while (retries > 0) {
                try {
                    const response = await fetch('https://runeapi.ordinalgenesis.xyz/claim/individualInfo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: requestBody
                    });

                    if (!response.ok) throw new Error('Network response was not ok');

                    const jsonResponse = await response.json();
                    const totalMerlRaw = jsonResponse.claimableTokenAmount;
                    const totalMerlFormatted = totalMerlRaw; // Formatting to two decimal places

                    return { merl: totalMerlFormatted };
                } catch (error) {
                    console.error('Failed to fetch balance for', address, error);
                    retries--;
                }
            }
            return { points: 'æ¥å£ç¹å¿™', merl: 'æ¥å£ç¹å¿™' };
        }

        function exportToCSV() {
            const addresses = addressInput.value.split('\n').filter(address => address.trim() !== '' && address.startsWith('0x'));
            let csvContent = "data:text/csv;charset=utf-8," + "é’±åŒ…åœ°å€,ç©ºæŠ•(ğŸ‘)\n";

            addresses.forEach(function(address, index) {
                const balanceText = document.getElementById('balance-' + index).textContent;
                const balance = balanceText.includes('æ­£åœ¨æŸ¥è¯¢') ? 'æŸ¥è¯¢ä¸­' : balanceText;
                csvContent += address + "," + balance + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "wallet_balances.csv");
            document.body.appendChild(link); // Required for FF

            link.click();
        }
    </script> 
    
</body>
</html>
